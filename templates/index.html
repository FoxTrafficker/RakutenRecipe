<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Balanced Eating Life</title>

    {% load static %}
    <link rel="stylesheet" href="{% static 'css/style.css' %}"/>
</head>
<body>

<!-- Navigation -->
<header class="navbar">
    <div class="logo">Balanced, Healthy, Clean</div>

    <nav>
        <a href="#">Benefits</a>
        <a href="#">Specifications</a>
        <a href="#">How-to</a>
        <a href="#">Contact Us</a>
    </nav>

    <button class="learn-btn">Learn More</button>
</header>

<!-- Hero -->
<section class="hero">
    <h1 class="title">Balanced Eating Life</h1>

    <!-- 中央搜索框 -->
    <div class="search-center">
        <div class="search-input-row">
            <input
                    type="text"
                    id="searchInput"
                    placeholder="Search items (e.g. オレンジ)…"
            />
            <button id="searchBtn">Search</button>
        </div>
        <span class="muted" id="searchHint">
      Try keywords like 「オレンジ」「チョコ」「クッキー」…
    </span>
    </div>

    <!-- 排行榜翻页按钮（保留原有） -->
    <div class="btn-row">
        <button class="btn" id="prevBtn">Prev ranking</button>
        <button class="btn" id="nextBtn">Next ranking</button>
        <span class="muted" id="pageInfo"></span>
    </div>
</section>


<!-- Ranking Section -->
<div class="section-title" id="rankingTitle">
    <div>Ranking items</div>
    <span id="rankingMeta"></span>
</div>
<section class="items" id="rank-items">
    <!-- JS will inject ranking cards -->
</section>


<!-- Search result Section -->
<div class="section-title" id="searchTitle" style="display:none;">
    <div>Search results</div>
    <span id="searchMeta"></span>
    <button class="btn" id="backToRankingBtn" style="margin-left:auto;">Back to ranking</button>
</div>

<!-- 搜索分页按钮条 -->
<div class="btn-row" id="searchPager" style="display:none; justify-content:center;">
    <button class="btn" id="searchPrevBtn">Prev</button>
    <button class="btn" id="searchNextBtn">Next</button>
    <span class="muted" id="searchPageInfo"></span>
</div>

<section class="items" id="search-items" style="display:none;">
    <!-- JS will inject search result cards -->
</section>


<div class="loading" id="loading" style="display:none;">Loading…</div>
<div class="error" id="error" style="display:none;"></div>

<script>
    // ======= Config =======
    const RANK_API_BASE = "http://127.0.0.1:8000/ichiba_ranking";
    const SEARCH_API_BASE = "http://127.0.0.1:8000/ichiba_item_search";
    const DEFAULT_GENRE_ID = "100227"; // 排行榜默认 genre

    let currentPage = 1;        // ranking 用
    let searchKeyword = "";     // search 用
    let searchPage = 1;
    const searchHits = 30;
    let searchMaxPage = 0;

    const urlParams = new URLSearchParams(location.search);
    if (urlParams.get("page")) {
        currentPage = parseInt(urlParams.get("page"), 10) || 1;
    }
    const currentGenre = urlParams.get("genreId") || DEFAULT_GENRE_ID;

    // ======= Helpers =======
    const yen = n => "¥" + Number(n).toLocaleString("ja-JP");

    function upscaleThumb(urlStr, size = "300x300") {
        try {
            const u = new URL(urlStr);
            if (u.searchParams.has("_ex")) {
                u.searchParams.set("_ex", size);
                return u.toString();
            }
        } catch (_) {
        }
        return urlStr;
    }

    function pickImage(item) {
        const list = item.mediumImageUrls || item.smallImageUrls || [];
        const first = Array.isArray(list) && list.length ? list[0] : null;
        return first ? upscaleThumb(first, "400x300") :
            "https://via.placeholder.com/400x300?text=No+Image";
    }

    function displayPrice(item) {
        if (Number(item.hasPriceRange) === 1) {
            const min = item.itemPriceMin1 || item.itemPriceMin2 || item.itemPriceMin3;
            const max = item.itemPriceMax1 || item.itemPriceMax2 || item.itemPriceMax3;
            if (min && max && min !== max) {
                return `${yen(min)}〜${yen(max)}`;
            }
        }
        return yen(item.itemPrice || 0);
    }

    function createCard(item) {
        const a = document.createElement("a");
        a.href = `/item_detail?itemCode=${encodeURIComponent(item.itemCode)}`;
        a.rel = "noopener noreferrer";

        const card = document.createElement("div");
        card.className = "card";

        const img = document.createElement("img");
        img.src = pickImage(item);
        img.alt = item.itemName || "item";

        const txt = document.createElement("div");
        txt.className = "text-box";

        const title = document.createElement("p");
        title.className = "title-text";
        title.textContent = item.itemName;

        const price = document.createElement("p");
        price.className = "price";
        price.textContent = displayPrice(item);

        txt.appendChild(title);
        txt.appendChild(price);

        card.appendChild(img);
        card.appendChild(txt);
        a.appendChild(card);
        return a;
    }


    function setLoading(v) {
        document.getElementById("loading").style.display = v ? "block" : "none";
    }

    function showError(msg) {
        const el = document.getElementById("error");
        el.textContent = msg;
        el.style.display = "block";
    }

    function setPageInfo() {
        document.getElementById("pageInfo").textContent =
            `genreId=${currentGenre} · page=${currentPage}`;
    }

    function hideRankingShowSearch() {
        document.getElementById("rankingTitle").style.display = "none";
        document.getElementById("rank-items").style.display = "none";

        document.getElementById("searchTitle").style.display = "flex";
        document.getElementById("search-items").style.display = "grid";
        document.getElementById("searchPager").style.display = "flex";
    }

    function showRankingOnly() {
        document.getElementById("rankingTitle").style.display = "flex";
        document.getElementById("rank-items").style.display = "grid";

        document.getElementById("searchTitle").style.display = "none";
        document.getElementById("search-items").style.display = "none";
        document.getElementById("searchPager").style.display = "none";
    }

    function updateSearchPagerInfo() {
        const info = document.getElementById("searchPageInfo");
        const prevBtn = document.getElementById("searchPrevBtn");
        const nextBtn = document.getElementById("searchNextBtn");

        info.textContent = `keyword="${searchKeyword}" · page=${searchPage}` +
            (searchMaxPage ? ` / ${searchMaxPage}` : "");

        prevBtn.disabled = searchPage <= 1;
        nextBtn.disabled = searchMaxPage && searchPage >= searchMaxPage;
    }

    // ======= Ranking (default) =======
    async function loadRanking(page = 1) {
        setLoading(true);
        document.getElementById("error").style.display = "none";
        setPageInfo();

        const itemsWrap = document.getElementById("rank-items");
        itemsWrap.innerHTML = "";

        const url =
            `${RANK_API_BASE}?genreId=${encodeURIComponent(currentGenre)}&page=${encodeURIComponent(page)}`;

        try {
            const res = await fetch(url);
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            const json = await res.json();

            if (json.code !== 0) throw new Error(json.msg || "API error");
            const arr = Array.isArray(json.data) ? json.data : [];

            if (!arr.length) {
                itemsWrap.innerHTML = '<div class="muted">No ranking items.</div>';
                return;
            }

            const frag = document.createDocumentFragment();
            arr.forEach(item => frag.appendChild(createCard(item)));
            itemsWrap.appendChild(frag);

            document.getElementById("rankingMeta").textContent =
                `${arr.length} items loaded`;
        } catch (e) {
            showError(`Failed to load ranking: ${e.message}`);
        } finally {
            setLoading(false);
        }
    }

    // ======= Search (keyword + pagination) =======
    async function runSearch(page) {
        const trimmed = (searchKeyword || "").trim();
        if (!trimmed) {
            showRankingOnly();
            return;
        }

        setLoading(true);
        document.getElementById("error").style.display = "none";

        const wrap = document.getElementById("search-items");
        const title = document.getElementById("searchTitle");
        const meta = document.getElementById("searchMeta");

        wrap.innerHTML = "";
        title.style.display = "flex";
        wrap.style.display = "grid";

        const url =
            `${SEARCH_API_BASE}?keyword=${encodeURIComponent(trimmed)}&page=${encodeURIComponent(page)}&hits=${encodeURIComponent(searchHits)}`;

        try {
            const res = await fetch(url);
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            const json = await res.json();

            if (json.code !== 0) throw new Error(json.msg || "API error");

            const data = json.data || {};
            const items = Array.isArray(data.Items) ? data.Items : [];
            const count = data.count || 0;
            const pageCount = data.pageCount || 0;
            const respPage = data.page || page;

            if (!items.length) {
                wrap.innerHTML = '<div class="muted">No results found.</div>';
                meta.textContent = `keyword="${trimmed}" · 0 item`;
                showRankingOnly(); // 没结果就不要盖住推荐
                return;
            }

            // 有结果 → 切换到搜索模式
            hideRankingShowSearch();

            searchPage = respPage;
            searchMaxPage = pageCount;

            const frag = document.createDocumentFragment();
            items.forEach(item => frag.appendChild(createCard(item)));
            wrap.appendChild(frag);

            meta.textContent =
                `keyword="${trimmed}" · ${items.length} items (total ${count || "?"})`;

            updateSearchPagerInfo();
        } catch (e) {
            showError(`Failed to search items: ${e.message}`);
        } finally {
            setLoading(false);
        }
    }

    // ======= Events =======
    // ranking 翻页
    document.getElementById("prevBtn").addEventListener("click", () => {
        if (currentPage > 1) {
            currentPage -= 1;
            loadRanking(currentPage);
            history.replaceState(null, "", `?genreId=${currentGenre}&page=${currentPage}`);
        }
    });

    document.getElementById("nextBtn").addEventListener("click", () => {
        currentPage += 1;
        loadRanking(currentPage);
        history.replaceState(null, "", `?genreId=${currentGenre}&page=${currentPage}`);
    });

    // search
    const searchInput = document.getElementById("searchInput");
    const searchBtn = document.getElementById("searchBtn");
    const backToRankingBtn = document.getElementById("backToRankingBtn");
    const searchPrevBtn = document.getElementById("searchPrevBtn");
    const searchNextBtn = document.getElementById("searchNextBtn");

    searchBtn.addEventListener("click", () => {
        searchKeyword = searchInput.value;
        runSearch(1);
    });

    searchInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
            searchKeyword = searchInput.value;
            runSearch(1);
        }
    });

    backToRankingBtn.addEventListener("click", () => {
        searchInput.value = "";
        searchKeyword = "";
        showRankingOnly();
    });

    searchPrevBtn.addEventListener("click", () => {
        if (searchPage > 1) {
            runSearch(searchPage - 1);
        }
    });

    searchNextBtn.addEventListener("click", () => {
        // 如果 API 返回了 pageCount，则不要超过上限；没有上限就直接加
        if (!searchMaxPage || searchPage < searchMaxPage) {
            runSearch(searchPage + 1);
        }
    });

    // 初始：显示排行榜
    showRankingOnly();
    loadRanking(currentPage);
</script>
</body>
</html>
