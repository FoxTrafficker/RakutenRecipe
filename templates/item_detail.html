<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Food Detail</title>
    {% load static %}
    <link rel="stylesheet" href="{% static 'css/food.css' %}"/>

    <style>
        /* 简单给 ranking 行做个横向布局，方便摆放材料商品 */
        .rank-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            padding: 12px 16px 24px;
        }

        .rank-item {
            display: grid;
            grid-template-columns: auto 1fr auto;
            gap: 12px;
            align-items: flex-start;
            padding: 10px 12px;
            border-radius: 10px;
            border: 1px solid #eee;
            background: #fff;
        }

        .rank-left {
            min-width: 140px;
        }

        .rank-title {
            font-weight: 600;
            font-size: 0.95rem;
            display: inline-block;
            margin-bottom: 4px;
        }

        .rank-num {
            display: inline-block;
            font-weight: 700;
            margin-right: 6px;
        }

        .rank-meta {
            font-size: 0.8rem;
            color: #666;
        }

        .rank-materials {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: flex-start;
        }

        .material-block {
            text-align: center;
            font-size: 0.8rem;
        }

        .material-image {
            width: 80px;
            height: 80px;
            object-fit: cover;
            display: block;
            border-radius: 8px;
            margin-bottom: 2px;
        }

        .material-name {
            max-width: 90px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: block;
        }

        .material-price {
            font-weight: 600;
        }

        .plus-sign {
            align-self: center;
            font-weight: 700;
            font-size: 1.2rem;
            padding: 0 4px;
        }

        .rank-right {
            text-align: right;
            min-width: 140px;
        }

        .rank-total {
            font-weight: 700;
            margin-bottom: 6px;
        }

        .cart-btn {
            padding: 6px 10px;
            font-size: 0.8rem;
            border-radius: 999px;
            border: none;
            background: #222;
            color: #fff;
            cursor: pointer;
        }

        .cart-btn:hover {
            background: #000;
        }

        .muted {
            color: #777;
            font-size: 0.8rem;
        }
    </style>
</head>

<body>
<header class="header">
    <div class="logo">Balanced, Healthy, Clean</div>
    <nav class="nav">
        <a href="#">Benefits</a>
        <a href="#">Specifications</a>
        <a href="#">How-to</a>
        <a href="#">Contact Us</a>
    </nav>
    <button class="learn-more">Learn More ></button>
</header>

<hr class="divider"/>

<!-- ====== 商品詳細 ====== -->
<section class="food-top">
    <div id="loading">Loading...</div>
    <div id="error" class="error" style="display:none;"></div>

    <div class="food-content">
        <div class="left">
            <h2 id="itemName"></h2>

            <p id="itemCaption"></p>

            <p>
                <strong>Price: </strong>
                <span id="itemPrice"></span>
                <br/>
                <strong>Review: </strong>
                <span id="reviewInfo"></span>
                <br/>
                <strong>Shop: </strong>
                <span id="shopName"></span>
            </p>

            <button class="more-info-btn">もっと見る</button>
        </div>

        <div class="right">
            <img id="itemImage" class="food-image"/>
        </div>
    </div>
</section>

<!-- ====== Recipe Ranking（材料 → ichiba_item_search）====== -->
<section class="ranking">
    <h2>一回買うと、何回もれくれる！</h2>
    <div class="rank-list" id="rankList">
    </div>
</section>

<footer class="footer">All Rights Reserved</footer>

<script>
    const DETAIL_API_BASE = "/ichiba_item_detail";
    const RECIPE_API_BASE = "/api/get_recipe/";
    const SEARCH_API_BASE = "/ichiba_item_search";
    const DETAIL_RECIPE_API_BASE = "/recipe";
    const SEARCH_DELAY_MS = 400;

    function sleep(ms) {
        return new Promise((resolve) => setTimeout(resolve, ms));
    }

    const urlParams = new URLSearchParams(location.search);
    const itemCode = urlParams.get("itemCode");

    if (!itemCode) {
        const err = document.getElementById("error");
        err.textContent = "No itemCode provided.";
        err.style.display = "block";
    } else {
        loadItemDetail(itemCode);
    }

    async function loadItemDetail(code) {
        const loading = document.getElementById("loading");
        const error = document.getElementById("error");
        loading.style.display = "block";

        try {
            const res = await fetch(
                `${DETAIL_API_BASE}?itemCode=${encodeURIComponent(code)}`
            );
            if (!res.ok) throw new Error(`HTTP ${res.status}`);

            const json = await res.json();
            if (json.code !== 0) throw new Error(json.msg || "API error");

            const data = json.data;
            renderDetail(data);
        } catch (e) {
            error.textContent = "Failed to load item detail: " + e.message;
            error.style.display = "block";
        } finally {
            loading.style.display = "none";
        }
    }

    function renderDetail(item) {
        document.getElementById("itemName").textContent = item.itemName;
        document.getElementById("itemCaption").textContent =
            item.itemCaption || "(No description)";
        document.getElementById("itemPrice").textContent =
            "¥" + Number(item.itemPrice).toLocaleString("ja-JP");
        document.getElementById("reviewInfo").textContent =
            `${item.reviewAverage} (${item.reviewCount} reviews)`;
        document.getElementById("shopName").textContent = item.shopName;

        const img =
            (item.mediumImageUrls && item.mediumImageUrls[0]) ||
            (item.smallImageUrls && item.smallImageUrls[0]) ||
            "";
        document.getElementById("itemImage").src =
            img.replace("_ex=128x128", "_ex=400x400");

        // ここで genreId からレシピランキングを取得
        if (item.genreId) {
            loadRecipeRanking(item.genreId);
        }
    }

    // ====== Recipe Ranking を取得 ======
    async function loadRecipeRanking(foodGenreId) {
        const list = document.getElementById("rankList");
        list.innerHTML = "<div class='muted'>Loading recipes…</div>";

        try {
            const url = `${RECIPE_API_BASE}?food_genreId=${encodeURIComponent(foodGenreId)}`;
            const res = await fetch(url);
            if (!res.ok) throw new Error(`HTTP ${res.status}`);

            const json = await res.json();
            if (json.code !== 0) throw new Error(json.msg || "API error");

            const recipes = Array.isArray(json.data) ? json.data : [];
            await renderRecipeRanking(recipes, foodGenreId);
        } catch (e) {
            list.innerHTML = "<div class='muted'>Failed to load recipes: " + e.message + "</div>";
        }
    }


    // 金額フォーマット
    const yen = (n) => "¥" + Number(n || 0).toLocaleString("ja-JP");

    async function renderRecipeRanking(recipes, foodGenreId) {
        const list = document.getElementById("rankList");
        list.innerHTML = "";

        if (!recipes.length) {
            list.innerHTML = "<div class='muted'>No related recipes found.</div>";
            return;
        }

        const sorted = recipes
            .sort((a, b) => (a.rank || 0) - (b.rank || 0))
            .slice(0, 3);

        for (let i = 0; i < sorted.length; i++) {
            const r = sorted[i];

            const row = document.createElement("div");
            row.className = "rank-item";

            const left = document.createElement("div");
            left.className = "rank-left";

            const num = document.createElement("span");
            num.className = "rank-num";
            num.textContent = r.rank ?? "";

            const title = document.createElement("a");
            title.className = "rank-title";
            title.href = `${DETAIL_RECIPE_API_BASE}?food_genreId=${encodeURIComponent(foodGenreId)}&rank=3&limit=3`;
            title.target = "_blank";
            title.rel = "noopener noreferrer";
            title.textContent = r.title || "(no title)";

            const meta = document.createElement("div");
            meta.className = "rank-meta";
            meta.textContent = `${r.time || ""} / ${r.cost || ""}`;

            left.appendChild(num);
            left.appendChild(title);
            left.appendChild(meta);

            const mid = document.createElement("div");
            mid.className = "rank-materials";

            const right = document.createElement("div");
            right.className = "rank-right";

            row.appendChild(left);
            row.appendChild(mid);
            row.appendChild(right);
            list.appendChild(row);

            await loadMaterialsForRecipe(r, mid, right);
            await sleep(400);
        }
    }


    // ====== 材料ごとに ichiba_item_search を呼んで表示 ======
    async function loadMaterialsForRecipe(recipe, midContainer, rightContainer) {
        const materials = Array.isArray(recipe.materials)
            ? recipe.materials
            : [];
        if (!materials.length) {
            midContainer.innerHTML =
                "<span class='muted'>材料情報がありません</span>";
            return;
        }

        midContainer.innerHTML = "";
        let totalPrice = 0;
        const foundItems = [];
        let shownCount = 0;   // 实际成功匹配到商品的材料数量

        for (let i = 0; i < materials.length; i++) {
            const mat = materials[i];
            if (!mat || !mat.trim()) continue;

            if (i > 0) {
                await sleep(SEARCH_DELAY_MS);
            }

            let product = null;

            // 先搜索看有没有商品
            try {
                const url = `${SEARCH_API_BASE}?keyword=${encodeURIComponent(
                    mat
                )}&page=1&hits=1`;
                const res = await fetch(url);
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const json = await res.json();
                if (json.code !== 0) throw new Error(json.msg || "API error");

                const data = json.data || {};
                const items = Array.isArray(data.Items) ? data.Items : [];
                if (!items.length) {
                    continue;
                }
                product = items[0];
            } catch (e) {
                console.error("search error for material:", mat, e);
                continue;
            }

            if (shownCount > 0) {
                const plus = document.createElement("span");
                plus.className = "plus-sign";
                plus.textContent = "+";
                midContainer.appendChild(plus);
            }

            const block = document.createElement("div");
            block.className = "material-block";

            const img = document.createElement("img");
            img.className = "material-image";

            const imgList =
                product.mediumImageUrls ||
                product.smallImageUrls ||
                [];
            const firstImg = imgList[0] || "";
            img.src = firstImg
                ? firstImg.replace("_ex=128x128", "_ex=200x200")
                : "https://via.placeholder.com/80x80?text=No+Img";
            img.alt = product.itemName || mat;

            const nameSpan = document.createElement("span");
            nameSpan.className = "material-name";
            nameSpan.textContent = product.itemName || mat;
            nameSpan.title = mat;  // 原始材料名放在 title 里

            const priceSpan = document.createElement("span");
            priceSpan.className = "material-price";
            const price = Number(product.itemPrice || 0);
            priceSpan.textContent = yen(price);

            totalPrice += price;
            foundItems.push({material: mat, product, price});

            block.appendChild(img);
            block.appendChild(nameSpan);
            block.appendChild(priceSpan);

            midContainer.appendChild(block);
            shownCount++;
        }

        // 右侧：合计 + 按钮
        rightContainer.innerHTML = "";

        const totalSpan = document.createElement("div");
        totalSpan.className = "rank-total";
        totalSpan.textContent = `おとくの ${yen(totalPrice)}`;

        const btn = document.createElement("button");
        btn.className = "cart-btn";
        btn.textContent = "全部カートに追加する";
        btn.addEventListener("click", () => {
            if (!foundItems.length) {
                alert("カートに追加できる商品がありません。");
                return;
            }
            alert(
                `以下の材料をカートに追加します（デモ）：\n` +
                foundItems
                    .map(
                        (x) =>
                            `${x.product.itemName || x.material} … ${yen(x.price)}`
                    )
                    .join("\n")
            );
        });

        rightContainer.appendChild(totalSpan);
        rightContainer.appendChild(btn);
    }

</script>
</body>
</html>
